# æ—§çš„ç”¨äºè·å–å¤©æ°”çš„apiä»£ç 
'''
## ä½¿ç”¨APIè·å¾—æ•°æ®çš„æ—§ä»£ç 
# def test_of_data():
#     city = "Perth"
#     # å‘é€ GET è¯·æ±‚
#     # æ ‡å‡†åŒ–æ ¼å¼
#     # response = requests.get(f'https://wttr.in/{city}?3&format=%l:+%c+%t+%C+%w')
#     # %l: åœ°å€
#     # %c: å½“å‰å¤©æ°”å›¾æ ‡
#     # %t: æ¸©åº¦
#     # %Cï¼šå¤©æ°”æè¿°
#     # %w: é£é€Ÿ
#     # è¾“å‡ºå“åº”å†…å®¹
#
#     # è®¿é—®é»˜è®¤æ ¼å¼
#     response = requests.get(f'https://wttr.in/{city}?format=j1')
#     data = response.json()
#     #è¾“å‡ºå®Œæ•´dataç”¨äºè§‚å¯Ÿæ•°æ®æ ¼å¼
#     print(data)
#     # è®¿é—®æœªæ¥ä¸‰å¤©çš„æ•°æ®
#     for day in data['weather']:
#         date = day['date']
#         maxtemp = day['maxtempC']
#         mintemp = day['mintempC']
#         description = day['hourly'][4]['weatherDesc'][0]['value']  # ä¸­åˆçš„å¤©æ°”
#         print(f"{date}: {description}, {mintemp}Â°C ~ {maxtemp}Â°C")
#         print(len(data['weather']))
'''
from collections import defaultdict

import requests


# è·å–å¤©æ°”æ•°æ®ï¼ˆè¿”å›JSONæ•°æ®ï¼‰
def get_weather_forecast(city, max_day):
    """
    æ¯ä¸ªå‡½æ•°éœ€è¦åŒ…å«ä¸€ä¸ªæ–‡æ¡£æè¿°ï¼Œå…¶ä¸­åŒ…å«å‡½æ•°è¯´æ˜ï¼Œè¾“å…¥å’Œè¾“å‡ºç¤ºä¾‹
    :param city:åŸå¸‚åç§°
    :param max_day:1-5çš„æ­£æ•´æ•°
    """
    # api's key
    api_key = "56d26083c4e5d4828784871da1b7b0b3"
    # api
    url = "https://api.openweathermap.org/data/2.5/forecast"
    params = {"q": city, "appid": api_key, "units": "metric", "lang": "zh_cn"  # todo:ä¿®æ”¹è¯­è¨€
              }
    try:
        response = requests.get(url, params=params)
        # è‹¥æ— å“åº”åˆ™æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        data = response.json()
        # å°è¯•è¾“å‡º
        # print(data)

        if response.status_code != 200:
            print("è¯·æ±‚å¤±è´¥:", data.get("message", "æœªçŸ¥é”™è¯¯"))
            return None

        # æŒ‰å¤©æ•´ç†æ¯3å°æ—¶çš„å¤©æ°”æ•°æ®
        forecast_by_day = defaultdict(list)
        for item in data["list"]:
            # æ—¥æœŸ
            date = item["dt_txt"].split(" ")[0]
            # æ¸©åº¦
            temp = item["main"]["temp"]
            # æè¿°
            desc = item["weather"][0]["description"]
            # é£é€Ÿ
            speed = item["wind"]["speed"]
            # æ¹¿åº¦
            humidity = item["main"]["humidity"]
            # é™æ°´ç‡
            pop = item.get("pop", 0)
            time = item["dt_txt"]
            forecast_by_day[date].append((time, temp, desc, speed, humidity, pop))

        # è¾“å‡ºæ¯æ—¥å¤©æ°”ï¼ˆä¼˜å…ˆå– 12:00 çš„æ•°æ®ï¼‰
        # print(f"åŸå¸‚ï¼š{data['city']['name']}")
        result = {"city": data["city"]["name"], "forecast": []}
        for date, items in list(forecast_by_day.items())[:max_day]:  # æœ€å¤š5å¤©
            # é€‰å–12:00æˆ–é»˜è®¤ç¬¬ä¸€æ¡
            mid = next((x for x in items if "12:00" in x[0]), items[0])
            # æµ‹è¯•è¯­å¥
            # print(f"æ—¥æœŸï¼š{date},å¤©æ°”æƒ…å†µï¼š{mid[2]},æ°”æ¸©ï¼š{mid[1]}Â°C,é£é€Ÿ:{mid[3]}, æ¹¿åº¦:{mid[4]},é™æ°´ç‡:{mid[5]}")

            result["forecast"].append(
                {"date": date, "time": mid[0], "temperature": mid[1], "description": mid[2], "speed": mid[3],
                 "humidity": mid[4], "pop": mid[5]

                 })

        return result, forecast_by_day  # result æ˜¯å¤©æ°”æ¦‚è¿°ï¼Œdataæ˜¯å…·ä½“å¤©æ°”æ•°æ®ï¼Œç”¨äºè·å¾—æŠ˜çº¿å›¾
    except requests.exceptions.RequestException as e:  # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼šè¯·æ£€æŸ¥ç½‘ç»œé“¾æ¥\n{e}")
        return None  # è¿”å›å¤±è´¥çš„è¿”å›å€¼
è¿™é‡Œæ˜¯æˆ‘çš„ä»£ç ï¼Œ
import ipywidgets as widgets

from IPython.display import display


def run_forecast_ui():
    html_text = widgets.HTML(
        value="<h2 style='color:#66ccff'>æ¬¢è¿ä½¿ç”¨äº¤äº’ç³»ç»Ÿ</h2><p>ä¸€ä¸ªç®€å•çš„é¢„æµ‹ç³»ç»Ÿã€‚</p>"
    )

    city = widgets.Text(
        value = "perth",
        placeholder='è¯·è¾“å…¥åŸå¸‚',
        description='åŸå¸‚åç§°ï¼š',
        disabled=False
    )

    max_day = widgets.Dropdown(
        options=[1, 2, 3, 4, 5],
        value=5,
        description='å¸Œæœ›é¢„æµ‹çš„å¤©æ•°(1-5å¤©)ï¼š',
        layout=widgets.Layout(width='300px'),
        style={'description_width': '150px'}
    )

    question_input = widgets.Text(
        value = "rain",
        placeholder='è¯·è¾“å…¥é—®é¢˜',
        description='æ‚¨æƒ³é—®äº›ä»€ä¹ˆå¤©æ°”é—®é¢˜ï¼š',
        disabled=False,
        layout=widgets.Layout(width='300px'),
        style={'description_width': '150px'}
    )

    predict_button = widgets.Button(
        description='é¢„æµ‹',
        button_style='',
        tooltip='ç‚¹æˆ‘ä¸€ä¸‹',
        icon='check'
    )

    exit_button = widgets.Button(
        description='é€€å‡º',
        button_style='danger',
        tooltip='ç»“æŸç¨‹åº',
        icon='sign-out-alt'
    )

    output = widgets.Output()


    # æŒ‰é’®ç‚¹å‡»å“åº”
    def on_predict_click(b):
        output.clear_output()

        city_name = city.value.strip()
        question = question_input.value.strip()
        day = int(max_day.value)

        city.value = ''
        question_input.value = ''
        max_day.value = 5

        _, _, _, index = validate_inputs(city_name, day, question)

        with output:
            if index == 0:
                print("âŒ è¾“å…¥æœ‰è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼š")
                print(f"åŸå¸‚ï¼š{city_name}")
                print(f"å¤©æ•°ï¼š{day}")
                print(f"é—®é¢˜ï¼š{question}")
            else:
                print("âœ… è¾“å…¥é€šè¿‡ï¼Œå›¾è¡¨å°†åœ¨ä¸‹æ–¹ç”Ÿæˆ")

                try:
                    line_chart(question, city_name, day)
                except Exception as e:
                    print("ğŸš« line_chart æ‰§è¡Œå¤±è´¥ï¼š", e)



    def on_exit_click(b):
        output.clear_output()
        ui_box.close()
        with output:
            print("å·²é€€å‡ºç³»ç»Ÿï¼Œæ„Ÿè°¢ä½¿ç”¨ï¼")

    predict_button.on_click(on_predict_click)
    exit_button.on_click(on_exit_click)

    # åŒ…è£¹å…¨éƒ¨æ§ä»¶ï¼Œä¾¿äºé€€å‡ºæ—¶ç»Ÿä¸€ close()
    ui_box = widgets.VBox([html_text, city, max_day, question_input,
                           widgets.HBox([predict_button, exit_button]),
                           output])
    display(ui_box)

æˆ‘æƒ³åœ¨ç”¨æˆ·è¾“å…¥çš„åŸå¸‚åç§°æ‰¾ä¸åˆ°æ—¶ï¼Œä¸å¯¹ç”¨æˆ·è¿”å›é”™è¯¯ä»£ç ï¼Œè€Œæ˜¯æç¤ºç”¨æˆ·è¾“å…¥é”™è¯¯
ChatGPT è¯´ï¼š

è¦åœ¨ç”¨æˆ·è¾“å…¥çš„åŸå¸‚åç§°æ‰¾ä¸åˆ°æ—¶æç¤ºç”¨æˆ·è¾“å…¥é”™è¯¯ï¼Œä½ å¯ä»¥åœ¨è°ƒç”¨å¤©æ°” API å‰è¿›è¡Œä¸€ä¸ªç®€å•çš„éªŒè¯ï¼Œæ£€æŸ¥è¿”å›çš„å“åº”ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„åŸå¸‚æ•°æ®ã€‚å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œåˆ™æç¤ºç”¨æˆ·è¾“å…¥é”™è¯¯ã€‚

ä½ å¯ä»¥åœ¨get_weather_forecastå‡½æ•°ä¸­è¿›è¡Œä¿®æ”¹ï¼Œä»¥ä¾¿åœ¨æ— æ³•æ‰¾åˆ°åŸå¸‚æ—¶ç»™å‡ºæ›´å‹å¥½çš„é”™è¯¯æç¤ºã€‚

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š

# è·å–å¤©æ°”æ•°æ®ï¼ˆè¿”å›JSONæ•°æ®ï¼‰
def get_weather_forecast(city, max_day):
    """
    æ¯ä¸ªå‡½æ•°éœ€è¦åŒ…å«ä¸€ä¸ªæ–‡æ¡£æè¿°ï¼Œå…¶ä¸­åŒ…å«å‡½æ•°è¯´æ˜ï¼Œè¾“å…¥å’Œè¾“å‡ºç¤ºä¾‹
    :param city: åŸå¸‚åç§°
    :param max_day: 1-5çš„æ­£æ•´æ•°
    """
    # api's key
    api_key = "56d26083c4e5d4828784871da1b7b0b3"
    # api
    url = "https://api.openweathermap.org/data/2.5/forecast"
    params = {"q": city, "appid": api_key, "units": "metric", "lang": "zh_cn"  # todo:ä¿®æ”¹è¯­è¨€
              }
    try:
        response = requests.get(url, params=params)
        # è‹¥æ— å“åº”åˆ™æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        data = response.json()

        if response.status_code != 200:
            print("è¯·æ±‚å¤±è´¥:", data.get("message", "æœªçŸ¥é”™è¯¯"))
            return None

        # æ£€æŸ¥è¿”å›æ•°æ®ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„åŸå¸‚ä¿¡æ¯
        if "city" not in data:
            print(f"åŸå¸‚ '{city}' æ‰¾ä¸åˆ°ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®ã€‚")
            return None

        # æŒ‰å¤©æ•´ç†æ¯3å°æ—¶çš„å¤©æ°”æ•°æ®
        forecast_by_day = defaultdict(list)
        for item in data["list"]:
            # æ—¥æœŸ
            date = item["dt_txt"].split(" ")[0]
            # æ¸©åº¦
            temp = item["main"]["temp"]
            # æè¿°
            desc = item["weather"][0]["description"]
            # é£é€Ÿ
            speed = item["wind"]["speed"]
            # æ¹¿åº¦
            humidity = item["main"]["humidity"]
            # é™æ°´ç‡
            pop = item.get("pop", 0)
            time = item["dt_txt"]
            forecast_by_day[date].append((time, temp, desc, speed, humidity, pop))

        # è¾“å‡ºæ¯æ—¥å¤©æ°”ï¼ˆä¼˜å…ˆå– 12:00 çš„æ•°æ®ï¼‰
        result = {"city": data["city"]["name"], "forecast": []}
        for date, items in list(forecast_by_day.items())[:max_day]:  # æœ€å¤š5å¤©
            # é€‰å–12:00æˆ–é»˜è®¤ç¬¬ä¸€æ¡
            mid = next((x for x in items if "12:00" in x[0]), items[0])

            result["forecast"].append(
                {"date": date, "time": mid[0], "temperature": mid[1], "description": mid[2], "speed": mid[3],
                 "humidity": mid[4], "pop": mid[5]})

        return result, forecast_by_day  # result æ˜¯å¤©æ°”æ¦‚è¿°ï¼Œdataæ˜¯å…·ä½“å¤©æ°”æ•°æ®ï¼Œç”¨äºè·å¾—æŠ˜çº¿å›¾
    except requests.exceptions.RequestException as e:  # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼šè¯·æ£€æŸ¥ç½‘ç»œé“¾æ¥\n{e}")
        return None  # è¿”å›å¤±è´¥çš„è¿”å›å€¼

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†å¦‚ä¸‹éªŒè¯ï¼š

    æ£€æŸ¥åŸå¸‚æ˜¯å¦æœ‰æ•ˆï¼šé€šè¿‡æ£€æŸ¥è¿”å›æ•°æ®ä¸­æ˜¯å¦åŒ…å« "city" å­—æ®µï¼Œå¦‚æœæ²¡æœ‰è¯¥å­—æ®µï¼Œåˆ™è¯´æ˜è¾“å…¥çš„åŸå¸‚æ— æ•ˆã€‚

    å‹å¥½çš„é”™è¯¯æç¤ºï¼šå¦‚æœåŸå¸‚æ— æ•ˆï¼Œè¿”å›ä¸€ä¸ªæç¤ºä¿¡æ¯ï¼Œå¦‚ åŸå¸‚ 'xxx' æ‰¾ä¸åˆ°ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›é”™è¯¯ä»£ç ã€‚

è¿™æ ·ï¼Œç”¨æˆ·åœ¨è¾“å…¥æ— æ•ˆåŸå¸‚åç§°æ—¶ï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªæ˜ç¡®çš„æç¤ºï¼Œè€Œä¸æ˜¯çœ‹åˆ°é”™è¯¯ä»£ç ã€‚
æ‚¨è¯´ï¼š
æˆ‘åœ¨åˆ«å¤„è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œ result, forecast_by_day = get_weather_forecast(city, max_day) è¿™æ ·ä¿®æ”¹çš„æŠ¥é”™æ€ä¹ˆè§£å†³
ChatGPT è¯´ï¼š

å¦‚æœä½ åœ¨è°ƒç”¨ get_weather_forecast å‡½æ•°æ—¶å‡ºç°äº†é”™è¯¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºå½“åŸå¸‚æ— æ•ˆæ—¶ï¼Œå‡½æ•°ä¼šè¿”å› Noneï¼Œè¿™ä¼šå¯¼è‡´è§£åŒ…å¤±è´¥ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æ—¶æ£€æŸ¥è¿”å›å€¼æ˜¯å¦æ˜¯ Noneï¼Œå¹¶æ ¹æ®æƒ…å†µå¤„ç†ã€‚
ä¿®æ”¹æ–¹æ³•ï¼š

åœ¨è°ƒç”¨ get_weather_forecast å‡½æ•°æ—¶ï¼Œå…ˆæ£€æŸ¥è¿”å›å€¼æ˜¯å¦ä¸º Noneï¼Œç„¶åå†è§£åŒ…ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨è°ƒç”¨åå¤„ç†æ—¶å¯ä»¥åŠ å…¥ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰å½“è¿”å›å€¼ä¸ä¸º None æ—¶æ‰è¿›è¡Œè§£åŒ…ã€‚

ä¿®æ”¹åçš„è°ƒç”¨éƒ¨åˆ†ä»£ç ï¼š

result, forecast_by_day = None, None  # åˆå§‹åŒ–ä¸º Noneï¼Œé¿å…è§£åŒ…å¤±è´¥

# è°ƒç”¨å‡½æ•°
response = get_weather_forecast(city, max_day)

# æ£€æŸ¥è¿”å›çš„ response æ˜¯å¦ä¸º None
if response:
    result, forecast_by_day = response
else:
    print("æ— æ³•è·å–å¤©æ°”æ•°æ®ï¼Œè¯·æ£€æŸ¥è¾“å…¥çš„åŸå¸‚åæˆ–ç½‘ç»œè¿æ¥ã€‚")
    # å¯ä»¥æ ¹æ®éœ€è¦åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå¤„ç†ï¼Œæ¯”å¦‚æç¤ºç”¨æˆ·é‡æ–°è¾“å…¥åŸå¸‚ç­‰

è§£é‡Šï¼š

    åœ¨è°ƒç”¨ get_weather_forecast(city, max_day) åï¼Œæ£€æŸ¥å…¶è¿”å›å€¼æ˜¯å¦ä¸º Noneã€‚

    å¦‚æœè¿”å›çš„æ˜¯æœ‰æ•ˆçš„æ•°æ®ï¼ˆå³ Noneï¼‰ï¼Œåˆ™è§£åŒ… result å’Œ forecast_by_dayã€‚

    å¦‚æœè¿”å› Noneï¼Œåˆ™è¾“å‡ºé”™è¯¯æç¤ºä¿¡æ¯å¹¶é¿å…è§£åŒ…é”™è¯¯ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥é˜²æ­¢åœ¨åŸå¸‚æ— æ•ˆæ—¶å°è¯•è§£åŒ… None å¯¼è‡´çš„é”™è¯¯ã€‚
æ‚¨è¯´ï¼š
æˆ‘çš„è°ƒç”¨æ¯”è¾ƒå¤æ‚ï¼Œæœ‰æ›´ç®€å•çš„å¤„ç†æ–¹å¼ä¹ˆ
ChatGPT è¯´ï¼š

å¦‚æœä½ çš„è°ƒç”¨é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ Python çš„ try-except è¯­å¥æ¥å¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œè¿™æ ·å¯ä»¥é¿å…æ‰‹åŠ¨æ£€æŸ¥æ¯æ¬¡è°ƒç”¨çš„è¿”å›å€¼ã€‚
æ›´ç®€åŒ–çš„å¤„ç†æ–¹æ³•ï¼š

ä½ å¯ä»¥ç›´æ¥åœ¨å‡½æ•°è°ƒç”¨æ—¶è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œè€Œä¸å¿…åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ£€æŸ¥è¿”å›å€¼ã€‚é€šè¿‡æ•è·è¿”å› None çš„æƒ…å†µï¼Œä½ å¯ä»¥ç®€åŒ–ä»£ç ç»“æ„ã€‚

ä¿®æ”¹åçš„ç¤ºä¾‹ï¼š

try:
    result, forecast_by_day = get_weather_forecast(city, max_day)
    if result is None:  # è¿›ä¸€æ­¥æ£€æŸ¥è¿”å›å€¼
        raise ValueError("æ— æ³•è·å–å¤©æ°”æ•°æ®ï¼ŒåŸå¸‚åç§°å¯èƒ½æ— æ•ˆã€‚")
except ValueError as e:
    print(f"é”™è¯¯: {e}")
except Exception as e:
    print(f"å‘ç”Ÿäº†å…¶ä»–é”™è¯¯: {e}")

è§£é‡Šï¼š

    try-except å—ï¼šå°è¯•è°ƒç”¨ get_weather_forecast å‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼è§£åŒ…ã€‚

    ValueError å¼‚å¸¸ï¼šå¦‚æœè¿”å›å€¼æ˜¯ Noneï¼Œé€šè¿‡ raise ValueError æ˜¾å¼æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¡¨ç¤ºæ— æ³•è·å–å¤©æ°”æ•°æ®ã€‚

    é€šç”¨å¼‚å¸¸æ•è·ï¼šexcept Exception as e æ•è·å…¶ä»–ç±»å‹çš„å¼‚å¸¸ï¼Œé˜²æ­¢ç¨‹åºå´©æºƒã€‚

è¿™æ ·ï¼Œä½ å¯ä»¥å°†é”™è¯¯å¤„ç†é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œæ— éœ€åœ¨æ¯æ¬¡è°ƒç”¨æ—¶è¿›è¡Œé¢å¤–æ£€æŸ¥ã€‚
æ‚¨è¯´ï¼š

            result["forecast"].append(
                {"date": date, "time": mid[0], "temperature": mid[1], "description": mid[2], "speed": mid[3],
                 "humidity": mid[4], "pop": mid[5]

                 })

        return result, forecast_by_day  # result æ˜¯å¤©æ°”æ¦‚è¿°ï¼Œdataæ˜¯å…·ä½“å¤©æ°”æ•°æ®ï¼Œç”¨äºè·å¾—æŠ˜çº¿å›¾
    except requests.exceptions.RequestException as e:  # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸
        print(f"è¯·æ±‚å¤±è´¥ï¼šå¯èƒ½æ˜¯åŸå¸‚åé”™è¯¯æˆ–è€…ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥\n{e}")
        return None  # è¿”å›å¤±è´¥çš„è¿”å›å€¼
è¿™æ˜¯æˆ‘çš„æŠ¥é”™ä»£ç ï¼Œæˆ‘å¸Œæœ›åªæ˜¾ç¤ºè¯·æ±‚å¤±è´¥ï¼šå¯èƒ½æ˜¯åŸå¸‚åé”™è¯¯æˆ–è€…ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼Œè€Œä¸æ˜¾ç¤ºç³»ç»Ÿçš„é”™è¯¯ä¿¡æ¯ï¼Œå¦‚ä½•å®ç°
ChatGPT è¯´ï¼š

ä½ å¯ä»¥é€šè¿‡åœ¨ except è¯­å¥ä¸­ä½¿ç”¨ logging æˆ–è€…ç®€å•çš„ print æ¥æ§åˆ¶é”™è¯¯è¾“å‡ºï¼Œé¿å…æ‰“å°ç³»ç»Ÿçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚é€šè¿‡æ•è· requests.exceptions.RequestExceptionï¼Œä½ å¯ä»¥ä»…æ˜¾ç¤ºè‡ªå®šä¹‰çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¾ç¤ºç³»ç»Ÿçš„é”™è¯¯å †æ ˆã€‚
ä¿®æ”¹åçš„ä»£ç ï¼š

import requests

# è·å–å¤©æ°”æ•°æ®ï¼ˆè¿”å›JSONæ•°æ®ï¼‰
def get_weather_forecast(city, max_day):
    """
    æ¯ä¸ªå‡½æ•°éœ€è¦åŒ…å«ä¸€ä¸ªæ–‡æ¡£æè¿°ï¼Œå…¶ä¸­åŒ…å«å‡½æ•°è¯´æ˜ï¼Œè¾“å…¥å’Œè¾“å‡ºç¤ºä¾‹
    :param city: åŸå¸‚åç§°
    :param max_day: 1-5çš„æ­£æ•´æ•°
    """
    # api's key
    api_key = "56d26083c4e5d4828784871da1b7b0b3"
    # api
    url = "https://api.openweathermap.org/data/2.5/forecast"
    params = {"q": city, "appid": api_key, "units": "metric", "lang": "zh_cn"  # todo:ä¿®æ”¹è¯­è¨€
              }
    try:
        response = requests.get(url, params=params)
        # è‹¥æ— å“åº”åˆ™æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        data = response.json()

        if response.status_code != 200:
            print("è¯·æ±‚å¤±è´¥:", data.get("message", "æœªçŸ¥é”™è¯¯"))
            return None

        # æ£€æŸ¥è¿”å›æ•°æ®ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„åŸå¸‚ä¿¡æ¯
        if "city" not in data:
            print(f"åŸå¸‚ '{city}' æ‰¾ä¸åˆ°ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®ã€‚")
            return None

        # æŒ‰å¤©æ•´ç†æ¯3å°æ—¶çš„å¤©æ°”æ•°æ®
        forecast_by_day = defaultdict(list)
        for item in data["list"]:
            # æ—¥æœŸ
            date = item["dt_txt"].split(" ")[0]
            # æ¸©åº¦
            temp = item["main"]["temp"]
            # æè¿°
            desc = item["weather"][0]["description"]
            # é£é€Ÿ
            speed = item["wind"]["speed"]
            # æ¹¿åº¦
            humidity = item["main"]["humidity"]
            # é™æ°´ç‡
            pop = item.get("pop", 0)
            time = item["dt_txt"]
            forecast_by_day[date].append((time, temp, desc, speed, humidity, pop))

        # è¾“å‡ºæ¯æ—¥å¤©æ°”ï¼ˆä¼˜å…ˆå– 12:00 çš„æ•°æ®ï¼‰
        result = {"city": data["city"]["name"], "forecast": []}
        for date, items in list(forecast_by_day.items())[:max_day]:  # æœ€å¤š5å¤©
            # é€‰å–12:00æˆ–é»˜è®¤ç¬¬ä¸€æ¡
            mid = next((x for x in items if "12:00" in x[0]), items[0])

            result["forecast"].append(
                {"date": date, "time": mid[0], "temperature": mid[1], "description": mid[2], "speed": mid[3],
                 "humidity": mid[4], "pop": mid[5]})

        return result, forecast_by_day  # result æ˜¯å¤©æ°”æ¦‚è¿°ï¼Œdataæ˜¯å…·ä½“å¤©æ°”æ•°æ®ï¼Œç”¨äºè·å¾—æŠ˜çº¿å›¾
    except requests.exceptions.RequestException:  # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸
        # åªæ˜¾ç¤ºè‡ªå®šä¹‰çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºç³»ç»Ÿçš„è¯¦ç»†é”™è¯¯å †æ ˆ
        print("è¯·æ±‚å¤±è´¥ï¼šå¯èƒ½æ˜¯åŸå¸‚åé”™è¯¯æˆ–è€…ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥")
        return None  # è¿”å›å¤±è´¥çš„è¿”å›å€¼

å…³é”®ä¿®æ”¹ï¼š

    å¼‚å¸¸æ•è·ï¼šåœ¨ except å—ä¸­ï¼Œæˆ‘ä»¬åªæ•è· requests.exceptions.RequestException å¼‚å¸¸ï¼Œè€Œä¸æ‰“å°è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚

    è‡ªå®šä¹‰é”™è¯¯æç¤ºï¼šä½¿ç”¨ print("è¯·æ±‚å¤±è´¥ï¼šå¯èƒ½æ˜¯åŸå¸‚åé”™è¯¯æˆ–è€…ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥") æ¥æ˜¾ç¤ºç®€å•çš„é”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¾ç¤ºç³»ç»Ÿçš„å †æ ˆä¿¡æ¯ã€‚

è¿™æ ·ï¼Œå½“å‡ºç°è¯·æ±‚å¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿåªä¼šè¾“å‡ºä½ è‡ªå®šä¹‰çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ³„æ¼å…·ä½“çš„å¼‚å¸¸å †æ ˆä¿¡æ¯ã€‚